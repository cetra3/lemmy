# TODO: The when: platform conditionals aren't working currently
# See https://github.com/woodpecker-ci/woodpecker/issues/1677

variables:
  - &muslrust_image "clux/muslrust:1.70.0"
  - &slow_check_paths
    - path:
        # rust source code
        - "**/*.rs"
        - "**/Cargo.toml"
        - "Cargo.lock"
        # database migrations
        - "migrations"
        # typescript tests
        - "api_tests"
        # config files and scripts used by ci
        - ".woodpecker.yml"
        - ".rustfmt.toml"
        - "scripts/update_config_defaults.sh"
        - "diesel.toml"
        - ".gitmodules"

# Broken for cron jobs currently, see
# https://github.com/woodpecker-ci/woodpecker/issues/1716
# clone:
#   git:
#     image: woodpeckerci/plugin-git
#     settings:
#       recursive: true
#       submodule_update_remote: true

pipeline:
  prepare_repo:
    image: alpine:3
    commands:
      - apk add git
      - git submodule init
      - git submodule update

  prettier_check:
    image: tmknom/prettier:3.0.0
    commands:
      - prettier -c . '!**/volumes' '!**/dist' '!target' '!**/translations'

  toml_fmt:
    image: tamasfe/taplo:0.8.1
    commands:
      - taplo format --check

  restore-cache:
    image: meltwater/drone-cache:v1
    pull: true
    settings:
      restore: true
      endpoint:
        from_secret: MINIO_ENDPOINT
      access-key:
        from_secret: MINIO_WRITE_USER
      secret-key:
        from_secret: MINIO_WRITE_PASSWORD
      bucket:
        from_secret: MINIO_BUCKET
      region: us-east-1
      cache_key: "rust-cache"
      backend_operation_timeout: 60m
      path-style: true
      mount:
        - ".cargo"
        - "target"
    secrets:
      [MINIO_ENDPOINT, MINIO_WRITE_USER, MINIO_WRITE_PASSWORD, MINIO_BUCKET]
    when: *slow_check_paths

  cargo_fmt:
    image: *muslrust_image
    environment:
      # store cargo data in repo folder so that it gets cached between steps
      CARGO_HOME: .cargo
    commands:
      # need make existing toolchain available
      - cp -n ~/.cargo . -r
      - rustup toolchain install nightly-2023-07-10
      - rustup component add rustfmt --toolchain nightly-2023-07-10
      - cargo +nightly-2023-07-10 fmt -- --check

  # make sure api builds with default features (used by other crates relying on lemmy api)
  check_api_common_default_features:
    image: *muslrust_image
    environment:
      CARGO_HOME: .cargo
    commands:
      - cargo check --package lemmy_api_common
    when: *slow_check_paths

  rebuild-cache:
    image: meltwater/drone-cache:v1
    pull: true
    settings:
      rebuild: true
      endpoint:
        from_secret: MINIO_ENDPOINT
      access-key:
        from_secret: MINIO_WRITE_USER
      secret-key:
        from_secret: MINIO_WRITE_PASSWORD
      bucket:
        from_secret: MINIO_BUCKET
      cache_key: "rust-cache"
      region: us-east-1
      path-style: true
      backend_operation_timeout: 60m
      mount:
        - ".cargo"
        - "target"
    secrets:
      [MINIO_ENDPOINT, MINIO_WRITE_USER, MINIO_WRITE_PASSWORD, MINIO_BUCKET]
    when: *slow_check_paths

  publish_release_docker:
    image: woodpeckerci/plugin-docker-buildx
    secrets: [docker_username, docker_password]
    settings:
      repo: dessalines/lemmy
      dockerfile: docker/Dockerfile
      platforms: linux/amd64
      build_args:
        - RUST_RELEASE_MODE=release
      auto_tag: true
    when:
      event: tag

  nightly_build:
    image: woodpeckerci/plugin-docker-buildx
    secrets: [docker_username, docker_password]
    settings:
      repo: dessalines/lemmy
      dockerfile: docker/Dockerfile
      platforms: linux/amd64
      build_args:
        - RUST_RELEASE_MODE=release
      tag: dev
    when:
      event: cron

  notify_on_failure:
    image: alpine:3
    commands:
      - apk add curl
      - "curl -d'Lemmy CI build failed: ${CI_BUILD_LINK}' ntfy.sh/lemmy_drone_ci"
    when:
      status: [failure]

  notify_on_tag_deploy:
    image: alpine:3
    commands:
      - apk add curl
      - "curl -d'lemmy:${CI_COMMIT_TAG} deployed' ntfy.sh/lemmy_drone_ci"
    when:
      event: tag

services:
  database:
    image: postgres:15.2-alpine
    environment:
      POSTGRES_USER: lemmy
      POSTGRES_PASSWORD: password
